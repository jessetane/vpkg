#!/usr/bin/env bash
#
# .vpkg for node
#

version() {
  echo "0.8.20"
}

pre_build() {
  
  # vars
  os=$(uname | awk '{ print(tolower($1)) }')
  arch=$(uname -p) && arch="${arch: -2}"
  fname="node-v${version}-${os}-x${arch}.tar.gz"
  archive="$src"/cache/"$fname"
  url="http://nodejs.org/dist/v$version/$fname"
  
  # download an archive of the requested
  # version if we don't already have it
  if [ ! -e "$archive" ]
  then
    
    # ensure dirs exists
    mkdir -p "$src"/cache
    mkdir -p "$src"/build
    
    # dl
    echo "downloading $url..."
    ! curl -fL# "$url" -o "$archive" && echo "$version: version could not be downloaded" >&2 && return 1
  fi
  
  # untar
  tar -xvzf "$archive" -C "$src"/build &> /dev/null
  
  # rename to $build - HACK: some versions untar
  # to non standard names, but globbing works since
  # they all seem to at least start with "node"
  mv "$src"/build/node* "$src"/build/"$build"
  
  # 
  echo "$src"/build/"$build"
}

# post_build() {
#   rm -rf "$src"/build/"$build"
# }
