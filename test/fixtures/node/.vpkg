#!/usr/bin/env bash
#
# vpkgfile for node
#

default_version="0.8.20"

common() {
  
  # args
  name="$1"
  version="$2"
  sourceVersion="$3"
  
  # validate
  [ -z "$VPKG_ROOT" ] && echo '$VPKG_ROOT must be defined' >&2 && exit 1
  [ -z "$name" ] && echo "please specify a name" >&2 && exit 1
  
  # defaults
  [ -z "$version" ] && version="$default_version"
  [ -z "$sourceVersion" ] && sourceVersion="$version"
  
  # some vars
  os=$(uname | awk '{ print(tolower($1)) }')
  arch=$(uname -p) && arch="${arch: -2}"
  fname="node-v$sourceVersion-$os-x$arch"
  url="http://nodejs.org/dist/v$sourceVersion/$fname.tar.gz"
  src="$VPKG_ROOT"/src/"$name"/build
}

install() {
  
  # setup args and vars
  common "$@"
  
  # we have source code?
  if [ ! -e "$src/$sourceVersion" ]
  then
    mkdir -p "$src" && cd $_
    echo "downloading $url..."
    ! curl -fO# "$url" && echo "version $sourceVersion could not be downloaded" >&2 && exit 1
    tar -xvzf "$fname".tar.gz > /dev/null 2>&1
    rm -rf "$fname".tar.gz
    mv node* "$sourceVersion"
  fi
  
  # install
  cd "$VPKG_ROOT"/lib/"$name"
  cp -R "$src/$sourceVersion" "$version"
}
