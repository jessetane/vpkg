#
# test
#

# go to own dir
cd "$(dirname "$BASH_SOURCE")"

# vars
t=1
expected=19


#
# helpers
#

check() {
  if [ $? = 0 ]
  then
    echo "✔  passed test #$((t++)): $1"
  else
    echo "✘  failed test #$((t++)): $1" >&2
    summary
    exit 1
  fi
}

clean_version() {
  while read data
  do
    echo "$data" | sed "s/[^0-9]*\(.*\)/\1/"
  done
}

summary() {
  [ $((--t)) = $expected ] && status="success" || status="failure"
  echo ""
  echo "------------------ $status ------------------"
  echo "$t of $expected tests passed"
}

teardown() {
  rm -rf tmp
}


#
# bootstrapping tests
#

test_bootstrap() {
  teardown
  
  # download vpkgfile
  url="file://$(pwd)/../vpkgfile"
  echo "downloading $url..."
  vpkgfile="$(curl -f# "$url")"
  check "download vpkgfile"
  
  # bootstrap
  mkdir tmp
  echo "$vpkgfile" | bash -s bootstrap "$(pwd)"/tmp
  check "bootstrap - create dirs and config"
  
  # source fresh config
  source tmp/.vpkg
  check "bootstrap - validate config"
  
  # check our binary linked properly
  test $(which vpkg) = "$VPKG_ROOT/bin/vpkg"
  check "bootstrap - test vpkg link"
  
  # include the vpkg function library
  source tmp/lib/vpkg/versions/current/lib/functions
  check "bootstrap - include vpkg function library"
}


#
# vpkgfile tests
#

setup_vpkgfile_tests() {
  fixture_name="nodejs"
  fixture_version_main="0.8.20"
  fixture_version_alt="0.9.9"
  fixture_bin="node"
}

test_vpkgfile_install() {
  echo "file://$(pwd)/fixtures/$fixture_name-vpkgfile" | vpkg install "$fixture_name"
  check "install $fixture_name"
}

test_vpkgfile_link() {
  vpkg link "$fixture_name" "$fixture_version_main"
  check "link $fixture_name $fixture_version_main"
  v="$("$fixture_bin" --version | clean_version)"
  test "$v" = "$fixture_version_main"
  check "check link version $v = $fixture_version_main"
}

test_vpkgfile_alt_install() {
  vpkg install "$fixture_name" "$fixture_version_alt"
  check "install $fixture_name $fixture_version_alt"
}

test_vpkgfile_use() {
  vpkg_use "$fixture_name" "$fixture_version_alt"
  check "vpkg_use $fixture_name $fixture_version_alt"
  v="$("$fixture_bin" --version | clean_version)"
  test "$v" = "$fixture_version_alt"
  check "check link version $v = $fixture_version_alt"
}
 
test_vpkgfile_unuse() {
  vpkg_unuse "$fixture_name" "$fixture_version_alt"
  check "vpkg_unuse $fixture_name $fixture_version_alt"
  v="$("$fixture_bin" --version | clean_version)"
  test "$v" = "$fixture_version_main"
  check "check link version $v = $fixture_version_main"
}

test_vpkgfile_uninstall() {
  vpkg uninstall "$fixture_name" "$fixture_version_main"
  check "uninstall $fixture_name $fixture_version_main"
  test ! -e "$VPKG_ROOT"/bin/"$fixture_bin"
  check "bin link was removed"
  test ! -e "$VPKG_ROOT"/lib/"$fixture_name"/versions/current
  check "version link was removed"
  test ! -e "$VPKG_ROOT"/lib/"$fixture_name"/versions/"$fixture_version_main"
  check "version $fixture_version_main was uninstalled"
}

test_vpkgfile_link_alt() {
  vpkg link "$fixture_name" "$fixture_version_alt"
  check "link $fixture_name $fixture_version_alt"
  v="$("$fixture_bin" --version | clean_version)"
  test "$v" = "$fixture_version_alt"
  check "check link version $v = $fixture_version_alt"
}


#
# no vpkgfile tests
#

# TODO...


#
# run the tests
#

# test bootstrapping
test_bootstrap

# nodejs requires only simple vpkgfile so 
# we'll use that package for our main tests
setup_vpkgfile_tests

# vpkgfile tests
test_vpkgfile_install
test_vpkgfile_link
test_vpkgfile_alt_install
test_vpkgfile_use
test_vpkgfile_unuse
test_vpkgfile_uninstall  # this also tests unlink...
test_vpkgfile_link_alt

# display a summary
summary
