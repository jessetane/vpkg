#
# test
#

# go to own dir
cd "$(dirname "$BASH_SOURCE")"

# vars
t=0

check() {
  if [ $? = 0 ]
  then
    echo "✔  passed test #$((t++)): $1"
  else
    echo "✘  failed test #$((t++)): $1" >&2
    exit 1
  fi
}

teardown() {
  rm -rf tmp
}

test_bootstrap() {
  teardown
  
  # download vpkgfile
  url="file://$(pwd)/../vpkgfile"
  echo "downloading $url..."
  vpkgfile="$(curl -f# "$url")"
  check "download vpkgfile"
  
  # bootstrap
  mkdir tmp
  echo "$vpkgfile" | bash -s bootstrap "$(pwd)"/tmp
  check "bootstrap - create dirs and config"
  
  # source fresh config
  source tmp/.vpkg
  check "bootstrap - validate config"
  
  # check our binary linked properly
  test $(which vpkg) = "$VPKG_ROOT/bin/vpkg"
  check "bootstrap - test vpkg link"
  
  # include the vpkg function library
  source tmp/lib/vpkg/versions/current/lib/functions
  check "bootstrap - include vpkg function library"
}

test_install() {
  echo "file://$(pwd)/fixtures/$fixture_name-vpkgfile" | vpkg install "$fixture_name"
  check "install $fixture_name"
}

test_link() {
  vpkg link "$fixture_name" "$fixture_version_main"
  check "link $fixture_name $fixture_version_main"
  v="$("$fixture_bin" --version)"
  test "$v" = "$fixture_version_main"
  check "link version was: $v, should be: $fixture_version_main"
}

test_alt_install() {
  vpkg install "$fixture_name" "$fixture_version_alt"
  check "install $fixture_name $fixture_version_alt"
}

test_use() {
  vpkg use "$fixture_name" "$fixture_version_alt"
  check "vpkg_use $fixture_name $fixture_version_alt"
  test "$("$fixture_bin" -v)" = "$fixture_version_alt"
  check "version is $fixture_version_alt"
}
 
test_unuse() {
  vpkg unuse "$fixture_name" "$fixture_version_alt"
  check "vpkg_unuse $fixture_name $fixture_version_alt"
  test "$("$fixture_bin" -v)" = "$fixture_version_main"
  check "version is $fixture_version_main"
}

test_uninstall() {
  vpkg uninstall "$fixture_name" "$fixture_version_main"
  check "uninstall $fixture_name $fixture_version_main"
  test ! -e "$VPKG_ROOT"/bin/"$fixture_bin"
  check "bin link was removed"
  test ! -e "$VPKG_ROOT"/lib/"$fixture_name"/versions/current
  check "version link was removed"
  test ! -e "$VPKG_ROOT"/lib/"$fixture_name"/versions/"$fixture_version_main"
  check "version $fixture_version_main was uninstalled"
}

test_link_alt() {
  vpkg link "$fixture_name" "$fixture_version_alt"
  check "link $fixture_name $fixture_version_alt"
  test "$("$fixture_bin" --version)" = "$fixture_version_alt"
  check "link version $fixture_version_alt"
}

# test bootstrapping
test_bootstrap

# nodejs requires only simple vpkgfile so 
# we'll use that package for our main tests
fixture_name="nodejs"
fixture_version_main="0.8.20"
fixture_version_alt="0.9.9"
fixture_bin="node"

# main tests
test_install
test_link
test_alt_install
test_use
test_unuse
test_uninstall  # this also tests unlink...
test_link_alt
