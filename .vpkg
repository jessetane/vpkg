#
# .vpkg
#

url() {
  echo "https://github.com/jessetane/vpkg"
}

version() {
  echo "HEAD"
}

install() {
  cd "$src"
  
  # get repo
  [ ! -d .git ] && git clone "$(url)" ./
  
  # checkout code
  git fetch --all
  git fetch --tags
  
  # install
  mkdir -p "$lib"/"$build" && cd $_
  cp -R "$src"/.git ./
  git reset --hard "$version"
}

bootstrap() {
  
  # require VPKG_HOME
  [ -z "$VPKG_HOME" ] && echo "VPKG_HOME is not defined" >&2 && return 1
  
  # vars
  name="vpkg"
  build="default"
  version="$(version)"
  bin="$VPKG_HOME"/bin
  src="$VPKG_HOME"/src/"$name"
  lib="$VPKG_HOME"/lib/"$name"
  
  # make some dirs
  mkdir -p "$src"
  mkdir -p "$bin"
  
  # autogenerate a sourceable profile
  # file and just put it in the root
  gen_profile > "$VPKG_HOME"/.vpkgrc
  
  # install default version of self
  install
  
  # source the config file
  . "$lib"/"$build"/bin/vpkg.sh
  
  # how meta: use the vpkg tool to link itself...
  vpkg link "$name" "$build"
}

gen_profile() {
  echo '#
# .vpkgrc - source this
#

# vpkg root
export VPKG_HOME="'"$VPKG_HOME"'"

# vpkg registries - add as many urls as you like, seperated by newlines
export VPKG_REGISTRIES="file://$VPKG_HOME/lib/vpkg/default/test/fixtures/registry.sample"

# add bin to PATH
export PATH="$VPKG_HOME"/bin:"$PATH"

# source vpkg command
. vpkg.sh
'
}

set -e

# run cmd or bootstrap
[ -n "$cmd" ] && "$cmd" || bootstrap
