#!/usr/bin/env bash
#
# vpkgfile
#

default_version="0.0.7"
repo_url="https://github.com/jessetane/vpkg"

gen_profile() {
  echo '#
# .vpkgrc - source this
#

# vpkg root
export VPKG_ROOT="'"$1"'"

# vpkg registries - add as many urls as you like, seperated by newlines
export VPKG_REGISTRY="https://raw.github.com/jessetane/vpkg-registry/master/registry"

# add bin to PATH
export PATH="$VPKG_ROOT"/bin:"$PATH"
'
}

install() {
  cd "$src"
  
  # get repo
  if [ ! -d .git ]
  then
    git clone "$repo_url" tmp
    mv tmp/.git ./
    rm -rf tmp
  fi
  
  # checkout code
  git fetch --all
  git fetch --tags
  git reset --hard "$source_version"
  
  # install
  cp -R . "$lib"/"$version"
}

bootstrap() {
  
  # args
  root="$1"
  name="vpkg"
  version="$default_version"
  source_version="$version"
  src="$root"/src/"$name"
  lib="$root"/lib/"$name"
  
  # default to pwd
  [ -z "$root" ] && echo "please specify a directory to bootstrap into" >&2 && exit 1
  
  # make some dirs
  mkdir -p "$src"
  mkdir -p "$lib"
  mkdir -p "$root"/bin
  
  # autogenerate a sourceable profile
  # file and just put it in the root
  gen_profile "$root" > "$root"/".vpkgrc"
  
  # source the config file
  source "$root"/".vpkgrc"
  
  # install default version of self
  install
  
  # ref to executable
  bin="$lib"/"$version"/bin/"$name"
  
  # how meta: use the vpkg tool to link itself...
  "$bin" link "$name" "$version"
}
